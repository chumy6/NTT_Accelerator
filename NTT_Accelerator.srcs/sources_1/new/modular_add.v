`timescale 1ns / 1ns

// 12位模加法模块（参数化模数q，默认值3329）
module modular_add #(
    parameter [11:0] q = 3329  // 可配置模数，默认3329（12位）
)(
    input [11:0]      a,      // 加数（12位无符号整数）
    input [11:0]      b,      // 加数（12位无符号整数）
    output reg [11:0] T       // 结果：(a + b) mod q
);
    
    reg [12:0]        T1;     // 中间结果：a + b（扩展为13位无符号数）
    reg signed [13:0] T2, T3; // 中间结果：减去偏移量后的带符号数
    
    always@(*) begin
        // 计算a + b，扩展为13位无符号数
        T1 = a + b;
        
        // 减去偏移量q << 4 + 1（16q + 1）
        T2 = T1 - {q[11:4], 4'b1};
        
        // 减去偏移量q << 5 + 2（32q + 2）
        T3 = T1 - {q[11:4], 4'b1, 1'b0};
        
        // 根据符号位选择结果
        if (T3[13] == 1'b0)        // T3 ≥ 0时使用T3
            T = T3[11:0];
        else if (T2[13] == 1'b0)   // T2 ≥ 0时使用T2
            T = T2[11:0];
        else                        // 否则使用T1
            T = T1[11:0];
    end
    
endmodule